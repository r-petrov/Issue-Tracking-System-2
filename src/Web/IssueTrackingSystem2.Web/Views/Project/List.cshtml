@using IssueTrackingSystem2.Web.ViewModels.Project
@model IEnumerable<ProjectListViewModel>

@{
    ViewData["Title"] = $"{this.User.Identity.Name}'s Affiliated Projects";
}

<h1>@ViewData["Title"]</h1>

<hr />
@if (this.User.IsInRole(GlobalConstants.AdministratorRoleName))
{
    <p>
        <a class="btn btn-success" asp-area="Administration" asp-controller="Project" asp-action="Create">
            <span class="text-dark font-weight-bold">Create New Project</span>
        </a>
    </p>

    <h2>Created projects by @this.User.Identity.Name</h2>
    if (Model != null && Model.Any())
    {
        <partial name="_ProjectsPartial" model="Model" />
    }
    else
    {
        <h3>@this.User.Identity.Name still have not created any projects</h3>
    }
}
else
{
    var isProjectLeader = Model.Where(model => model.Leader.Id == this.UserManager.GetUserId(this.User)).Any();
    if (isProjectLeader)
    {
        <h2>Projects that @this.User.Identity.Name is a Project Leader</h2>
        <partial name="_ProjectsPartial"
                 model="@Model.Where(model => model.Leader.Id == this.UserManager.GetUserId(this.User))" />
    }

    var isIssueAssignee = Model
        .Where(model => model.Milestones
            .Any(milestone => milestone.Issues
                .Any(issue => issue.AssigneeId == this.UserManager.GetUserId(this.User))))
        .Any();

    if (isIssueAssignee)
    {
        <h2>Projects with issues that @this.User.Identity.Name is an Issue Assignee</h2>
        <partial name="_ProjectsPartial"
                 model="@Model
                            .Where(model => model.Milestones
                                .Any(milestone => milestone.Issues
                                    .Any(issue => issue.AssigneeId == this.UserManager.GetUserId(this.User))))" />
    }

    @if (!isProjectLeader && !isIssueAssignee)
    {
        <h3>
            @string.Format(
                format: MessagesConstants.StillHaveNotBeenAssignedTo,
                arg0: this.User.Identity.Name,
                arg1: $"{GlobalConstants.Projects} or {GlobalConstants.Issues}")
        </h3>
    }
}
